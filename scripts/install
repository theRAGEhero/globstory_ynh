#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

ynh_abort_if_errors
pkg_version="$(awk -F'"' '/^version =/ {print $2; exit}' "$pkg_root_dir/manifest.toml")"

#=================================================
# COLLECT ARGUMENTS AND INITIALISE SETTINGS
#=================================================
domain=$YNH_APP_ARG_DOMAIN
path_url=$YNH_APP_ARG_PATH
init_main_permission=$YNH_APP_ARG_INIT_MAIN_PERMISSION

ynh_app_setting_set --app="$app" --key=domain --value="$domain"
ynh_app_setting_set --app="$app" --key=path --value="$path_url"
ynh_app_setting_set --app="$app" --key=init_main_permission --value="$init_main_permission"

install_dir="$(ensure_install_dir)"
web_root="$install_dir/html"

#=================================================
# DEPLOY APPLICATION FILES
#=================================================
ynh_script_progression --message="Deploying application files..."
mkdir -p "$web_root"
rsync -a "$pkg_sources_dir/app/" "$web_root"/
chown -R "$app":www-data "$web_root"
chmod -R u=rwX,g=rX,o= "$web_root"

#=================================================
# NGINX CONFIGURATION
#=================================================
ynh_script_progression --message="Configuring web server..."
ynh_config_add_nginx

ynh_systemctl --service=nginx --action=reload

#=================================================
# FINALISE INSTALLATION
#=================================================
ynh_app_setting_set --app="$app" --key=installed_version --value="$pkg_version"
ynh_script_progression --message="Installation of $app completed"
